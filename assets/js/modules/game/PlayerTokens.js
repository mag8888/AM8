/**
 * PlayerTokens v1.0.0
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏—à–µ–∫ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –∏–≥—Ä–æ–≤–æ–º –ø–æ–ª–µ
 */

console.log('üéØ PlayerTokens: –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');

class PlayerTokens {
    constructor(config = {}) {
        this.gameState = config.gameState || null;
        this.eventBus = config.eventBus || null;
        this.outerTrackSelector = config.outerTrackSelector || '#outer-track';
        this.innerTrackSelector = config.innerTrackSelector || '#inner-track';
        
        this.tokens = new Map(); // –•—Ä–∞–Ω–µ–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–∏—à–µ–∫
        
        console.log('üéØ PlayerTokens: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
        this.init();
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
     */
    init() {
        this.setupEventListeners();
        this.addStyles();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏—à–∫–∏ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
            this.forceUpdate();
        }, 1000);
        
        console.log('‚úÖ PlayerTokens: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
    
    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
     */
    setupEventListeners() {
        if (this.eventBus) {
            this.eventBus.on('game:playersUpdated', (data) => {
                console.log('üéØ PlayerTokens: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ game:playersUpdated', data);
                this.updateTokens(data.players);
            });
            
            this.eventBus.on('player:positionUpdated', (data) => {
                console.log('üéØ PlayerTokens: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ player:positionUpdated', data);
                this.updateTokenPosition(data.playerId, data.position, data.player.isInner);
            });
            
            this.eventBus.on('game:started', () => {
                console.log('üéØ PlayerTokens: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ game:started');
                // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã —Ä–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏—à–∫–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                if (this.gameState && this.gameState.players) {
                    this.renderTokens(this.gameState.players);
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ GameStateManager
            this.eventBus.on('players:updated', (data) => {
                console.log('üéØ PlayerTokens: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ players:updated', data);
                this.updateTokens(data.players);
            });
        } else {
            console.warn('‚ö†Ô∏è PlayerTokens: EventBus –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
    }
    
    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –¥–ª—è —Ñ–∏—à–µ–∫
     */
    addStyles() {
        if (document.getElementById('player-tokens-styles')) {
            console.log('üéØ PlayerTokens: –°—Ç–∏–ª–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
            return;
        }
        
        console.log('üéØ PlayerTokens: –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏—à–µ–∫');
        const styles = document.createElement('style');
        styles.id = 'player-tokens-styles';
        styles.textContent = `
            .player-token {
                position: absolute;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.4rem;
                font-weight: bold;
                border: 3px solid rgba(255, 255, 255, 0.9);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(255, 255, 255, 0.2);
                transition: all 0.3s ease;
                z-index: 200;
                pointer-events: none;
                backdrop-filter: blur(5px);
            }
            
            .player-token:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            }
            
            .player-token.outer {
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
            }
            
            .player-token.inner {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
            }
            
            .player-token.multiple {
                /* –°—Ç–∏–ª–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∏—à–µ–∫ –Ω–∞ –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–µ */
            }
            
            /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–∏—à–∫–∏ */
            @keyframes tokenAppear {
                from {
                    opacity: 0;
                    transform: scale(0);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            .player-token.appearing {
                animation: tokenAppear 0.3s ease-out;
            }
            
            /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è */
            @keyframes tokenMove {
                from {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.2);
                }
                to {
                    transform: scale(1);
                }
            }
            
            .player-token.moving {
                animation: tokenMove 0.5s ease-in-out;
            }
        `;
        
        document.head.appendChild(styles);
    }
    
    /**
     * –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∏—à–µ–∫
     */
    clearTokens() {
        this.tokens.forEach((token) => {
            if (token.parentNode) {
                token.parentNode.removeChild(token);
            }
        });
        this.tokens.clear();
    }
    
    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ GameStateManager
     */
    getPlayers() {
        if (this.gameState && this.gameState.players) {
            return this.gameState.players;
        }
        return [];
    }
    
    /**
     * –†–µ–Ω–¥–µ—Ä —Ñ–∏—à–µ–∫ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
     */
    renderTokens(players) {
        console.log('üéØ PlayerTokens: renderTokens –≤—ã–∑–≤–∞–Ω —Å –∏–≥—Ä–æ–∫–∞–º–∏:', players);
        
        if (!players || players.length === 0) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ GameState
            players = this.getPlayers();
            console.log('üéØ PlayerTokens: –ü–æ–ª—É—á–µ–Ω—ã –∏–≥—Ä–æ–∫–∏ –∏–∑ GameState:', players);
            if (!players || players.length === 0) {
                console.warn('‚ö†Ô∏è PlayerTokens: –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }
        }
        
        console.log('üéØ PlayerTokens: –†–µ–Ω–¥–µ—Ä —Ñ–∏—à–µ–∫ –¥–ª—è', players.length, '–∏–≥—Ä–æ–∫–æ–≤');
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Å–º–µ—â–µ–Ω–∏—è
        const positionGroups = new Map();
        
        players.forEach((player, index) => {
            const position = player.position || 0;
            const isInner = player.isInner || false;
            
            if (!positionGroups.has(`${position}-${isInner}`)) {
                positionGroups.set(`${position}-${isInner}`, []);
            }
            positionGroups.get(`${position}-${isInner}`).push(player);
        });
        
        // –°–æ–∑–¥–∞–µ–º —Ñ–∏—à–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
        positionGroups.forEach((playersAtPosition, positionKey) => {
            const [position, isInner] = positionKey.split('-');
            this.createTokensAtPosition(playersAtPosition, parseInt(position), isInner === 'true');
        });
    }
    
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏—à–µ–∫ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
     */
    createTokensAtPosition(players, position, isInner) {
        console.log('üéØ PlayerTokens: createTokensAtPosition', { players, position, isInner });
        
        const trackSelector = isInner ? this.innerTrackSelector : this.outerTrackSelector;
        const trackElement = document.querySelector(trackSelector);
        
        if (!trackElement) {
            console.warn('‚ö†Ô∏è PlayerTokens: –¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω:', trackSelector);
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç—Ä–µ–∫–∞
        const trackRect = trackElement.getBoundingClientRect();
        console.log('üéØ PlayerTokens: –¢—Ä–µ–∫ –Ω–∞–π–¥–µ–Ω:', {
            element: trackElement,
            selector: trackSelector,
            width: trackRect.width,
            height: trackRect.height,
            x: trackRect.x,
            y: trackRect.y,
            isVisible: trackRect.width > 0 && trackRect.height > 0
        });
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–ª–µ—Ç–∫—É –ø–æ –ø–æ–∑–∏—Ü–∏–∏
        const cell = trackElement.querySelector(`[data-position="${position}"]`);
        if (!cell) {
            console.warn('‚ö†Ô∏è PlayerTokens: –ö–ª–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏:', position);
            return;
        }
        
        const cellRect = cell.getBoundingClientRect();
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é (—Ü–µ–Ω—Ç—Ä –∫–ª–µ—Ç–∫–∏)
        const baseX = cellRect.left - trackRect.left + cellRect.width / 2;
        const baseY = cellRect.top - trackRect.top + cellRect.height / 2;
        
        // –°–æ–∑–¥–∞–µ–º —Ñ–∏—à–∫–∏ —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º
        players.forEach((player, index) => {
            const token = this.createPlayerToken(player, index, players.length);
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∏—à–µ–∫
            const offset = this.calculateOffset(index, players.length);
            
            token.style.left = `${baseX + offset.x - 16}px`; // -16 –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (32px/2)
            token.style.top = `${baseY + offset.y - 16}px`;
            
            trackElement.appendChild(token);
            this.tokens.set(player.id, token);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
            this.animateTokenAppearance(token);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ñ–∏—à–∫–∏
            setTimeout(() => {
                const rect = token.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(token);
                console.log(`üéØ PlayerTokens: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ–∏—à–∫–∏ ${player.username}:`, {
                    isVisible: rect.width > 0 && rect.height > 0,
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    position: computedStyle.position,
                    left: computedStyle.left,
                    top: computedStyle.top,
                    zIndex: computedStyle.zIndex,
                    rect: {
                        width: rect.width,
                        height: rect.height,
                        x: rect.x,
                        y: rect.y
                    }
                });
            }, 100);
            
            console.log(`üéØ PlayerTokens: –§–∏—à–∫–∞ ${player.username} —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ ${position}`);
        });
    }
    
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–∞ —Ñ–∏—à–∫–∏
     */
    createPlayerToken(player, index, totalPlayers) {
        console.log(`üéØ PlayerTokens: createPlayerToken –¥–ª—è ${player.username}:`, {
            player: player,
            token: player.token,
            position: player.position,
            isInner: player.isInner
        });
        
        const token = document.createElement('div');
        token.className = `player-token ${player.isInner ? 'inner' : 'outer'}`;
        token.dataset.playerId = player.id;
        token.dataset.playerName = player.username;
        token.setAttribute('data-position', player.position || 0); // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç –ø–æ–∑–∏—Ü–∏–∏
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∫–æ–Ω–∫—É —Ñ–∏—à–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞
        const tokenIcon = this.getTokenIcon(player.token);
        token.textContent = tokenIcon;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∏–≥—Ä–æ–∫–µ –≤ title
        token.title = `${player.username} - $${player.money || 0}`;
        
        console.log(`üéØ PlayerTokens: –°–æ–∑–¥–∞–Ω–∞ —Ñ–∏—à–∫–∞ –¥–ª—è ${player.username}:`, {
            className: token.className,
            textContent: token.textContent,
            dataPosition: token.getAttribute('data-position')
        });
        
        return token;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏–∫–æ–Ω–∫—É —Ç–æ–∫–µ–Ω–∞
     */
    getTokenIcon(tokenId) {
        const tokenIcons = {
            'lion': 'ü¶Å',
            'eagle': 'ü¶Ö', 
            'fox': 'ü¶ä',
            'bear': 'üêª',
            'tiger': 'üêÖ',
            'wolf': 'üê∫',
            'elephant': 'üêò',
            'shark': 'ü¶à',
            'owl': 'ü¶â',
            'dolphin': 'üê¨'
        };
        
        const icon = tokenIcons[tokenId] || 'üéØ';
        console.log(`üéØ PlayerTokens: getTokenIcon(${tokenId}) = ${icon}`);
        return icon;
    }
    
    /**
     * –†–∞—Å—á–µ—Ç —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∏—à–µ–∫
     */
    calculateOffset(index, totalPlayers) {
        if (totalPlayers === 1) {
            return { x: 0, y: 0 };
        }
        
        // –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º —Ñ–∏—à–∫–∏ –ø–æ –∫—Ä—É–≥—É
        const angle = (index * 2 * Math.PI) / totalPlayers;
        const radius = 12; // –†–∞–¥–∏—É—Å —Å–º–µ—â–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö (—É–≤–µ–ª–∏—á–µ–Ω –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤)
        
        return {
            x: Math.cos(angle) * radius,
            y: Math.sin(angle) * radius
        };
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Ñ–∏—à–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
     */
    updateTokenPosition(playerId, newPosition, isInner) {
        const token = this.tokens.get(playerId);
        if (!token) {
            console.warn('‚ö†Ô∏è PlayerTokens: –§–∏—à–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞:', playerId);
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ data-position
        const currentPosition = parseInt(token.getAttribute('data-position')) || 0;
        
        console.log(`üéØ PlayerTokens: –î–≤–∏–∂–µ–Ω–∏–µ —Ñ–∏—à–∫–∏ ${playerId} —Å –ø–æ–∑–∏—Ü–∏–∏ ${currentPosition} –Ω–∞ ${newPosition}`);
        
        // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (currentPosition === newPosition) {
            console.log('üéØ PlayerTokens: –ü–æ–∑–∏—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ');
            return;
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ—à–∞–≥–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
        this.moveTokenStepByStep(token, playerId, currentPosition, newPosition, isInner);
    }
    
    /**
     * –ü–æ—à–∞–≥–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Ñ–∏—à–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
     */
    moveTokenStepByStep(token, playerId, fromPosition, toPosition, isInner) {
        const trackSelector = isInner ? this.innerTrackSelector : this.outerTrackSelector;
        const trackElement = document.querySelector(trackSelector);
        
        if (!trackElement) {
            console.warn('‚ö†Ô∏è PlayerTokens: –¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω:', trackSelector);
            return;
        }
        
        const maxPosition = isInner ? 23 : 43; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Ç—Ä–µ–∫–æ–≤
        const steps = [];
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∞–≥–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        let currentPos = fromPosition;
        while (currentPos !== toPosition) {
            currentPos = (currentPos + 1) % (maxPosition + 1);
            steps.push(currentPos);
        }
        
        console.log(`üéØ PlayerTokens: –®–∞–≥–∏ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è ${playerId}:`, steps);
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–∞–∂–¥—ã–π —à–∞–≥ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        let stepIndex = 0;
        const moveToNextStep = () => {
            if (stepIndex >= steps.length) {
                console.log(`üéØ PlayerTokens: –î–≤–∏–∂–µ–Ω–∏–µ —Ñ–∏—à–∫–∏ ${playerId} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);
                return;
            }
            
            const stepPosition = steps[stepIndex];
            const cell = trackElement.querySelector(`[data-position="${stepPosition}"]`);
            
            if (cell) {
                const cellRect = cell.getBoundingClientRect();
                const trackRect = trackElement.getBoundingClientRect();
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
                const newX = cellRect.left - trackRect.left + cellRect.width / 2 - 12;
                const newY = cellRect.top - trackRect.top + cellRect.height / 2 - 12;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Ñ–∏—à–∫–∏
                const currentX = parseFloat(token.style.left) || 0;
                const currentY = parseFloat(token.style.top) || 0;
                
                // –ê–Ω–∏–º–∏—Ä—É–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–ª–µ—Ç–∫–µ
                this.animateTokenMovement(token, currentX, currentY, newX, newY);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç –ø–æ–∑–∏—Ü–∏–∏
                token.setAttribute('data-position', stepPosition);
                
                console.log(`üéØ PlayerTokens: –®–∞–≥ ${stepIndex + 1}/${steps.length}: –ø–æ–∑–∏—Ü–∏—è ${stepPosition}`);
                
                stepIndex++;
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É —á–µ—Ä–µ–∑ 500–º—Å
                setTimeout(moveToNextStep, 500);
            } else {
                console.warn('‚ö†Ô∏è PlayerTokens: –ö–ª–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏:', stepPosition);
                stepIndex++;
                setTimeout(moveToNextStep, 100);
            }
        };
        
        // –ù–∞—á–∏–Ω–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
        moveToNextStep();
    }
    
    /**
     * –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —Ñ–∏—à–∫–∏
     */
    animateTokenMovement(token, fromX, fromY, toX, toY) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        token.classList.add('moving');
        
        // –°–æ–∑–¥–∞–µ–º keyframes –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const keyframes = [
            { 
                left: `${fromX}px`, 
                top: `${fromY}px`,
                transform: 'scale(1)'
            },
            { 
                left: `${(fromX + toX) / 2}px`, 
                top: `${(fromY + toY) / 2}px`,
                transform: 'scale(1.2)'
            },
            { 
                left: `${toX}px`, 
                top: `${toY}px`,
                transform: 'scale(1)'
            }
        ];
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        token.animate(keyframes, {
            duration: 800,
            easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
            fill: 'forwards'
        }).onfinish = () => {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
            token.style.left = `${toX}px`;
            token.style.top = `${toY}px`;
            
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
            token.classList.remove('moving');
        };
    }
    
    /**
     * –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–∏—à–∫–∏
     */
    animateTokenAppearance(token) {
        const keyframes = [
            { 
                opacity: '0',
                transform: 'scale(0) rotate(0deg)'
            },
            { 
                opacity: '1',
                transform: 'scale(1.2) rotate(180deg)'
            },
            { 
                opacity: '1',
                transform: 'scale(1) rotate(360deg)'
            }
        ];
        
        token.animate(keyframes, {
            duration: 600,
            easing: 'cubic-bezier(0.68, -0.55, 0.265, 1.55)',
            fill: 'forwards'
        });
    }
    
    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∏—à–µ–∫
     */
    updateTokens(players) {
        this.clearTokens();
        this.renderTokens(players);
    }
    
    /**
     * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏—à–µ–∫ –∏–∑ GameState
     */
    forceUpdate() {
        const players = this.getPlayers();
        this.updateTokens(players);
    }
}

console.log('üéØ PlayerTokens: –ö–ª–∞—Å—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ window...');
window.PlayerTokens = PlayerTokens;
console.log('üéØ PlayerTokens: –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, window.PlayerTokens =', !!window.PlayerTokens);
