# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–ø–∞–º-–∑–∞–ø—Ä–æ—Å–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–í –∫–æ–Ω—Å–æ–ª–∏ –Ω–∞–±–ª—é–¥–∞–ª–∏—Å—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:
- `BankPreview: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑-–∑–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ rate limiting`
- `GameStateLimiter: –ó–∞–ø—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã [room-id]`

–≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–ª–æ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å race condition –∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –ª–æ–≥–∏–∫–æ–π rate limiting.

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **Race Condition –≤ BankPreview.js**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã `updatePreviewData()`
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç concurrent –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ rate limiting

### 2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –≤ GameStateLimiter**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–∏—Å—Ç–∫–∏ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (5 —Å–µ–∫)
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ race conditions

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **BankPreview.js**
```javascript
// –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
if (this._isUpdating) {
    return;
}
this._isUpdating = true;

// –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ pending —Ñ–ª–∞–≥–∞
if (!window.CommonUtils.gameStateLimiter.setRequestPending(roomId)) {
    console.log('üö´ BankPreview: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑-–∑–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ rate limiting –∏–ª–∏ concurrent request');
    return;
}

// Debounced –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–±—ã—Ç–∏–π
this.updatePreviewDataDebounced = window.CommonUtils.debounce(() => {
    this.updatePreviewData();
}, 2000);

// –£–≤–µ–ª–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å 30 –¥–æ 45 —Å–µ–∫—É–Ω–¥
this.updateInterval = setInterval(() => {
    this.updatePreviewData();
}, 45000);
```

### 2. **CommonUtils.js - GameStateLimiter**
```javascript
static gameStateLimiter = {
    _minInterval: 8000, // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 5 –¥–æ 8 —Å–µ–∫—É–Ω–¥
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (>30 —Å–µ–∫)
    canMakeRequest(roomId) {
        if (this._pendingRequests.has(key)) {
            const elapsedSincePending = now - this._pendingRequests.get(key);
            if (elapsedSincePending > 30000) {
                console.log(`‚ö†Ô∏è GameStateLimiter: –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–π –∑–∞–ø—Ä–æ—Å`);
                this._pendingRequests.delete(key);
            }
        }
    },
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    clearStaleRequests() {
        const staleKeys = [];
        for (const [key, timestamp] of this._pendingRequests.entries()) {
            if (now - timestamp > 30000) {
                staleKeys.push(key);
            }
        }
        staleKeys.forEach(key => this._pendingRequests.delete(key));
        return staleKeys.length;
    }
};
```

### 3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**
```javascript
// –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
this.cleanupInterval = setInterval(() => {
    if (window.CommonUtils && window.CommonUtils.gameStateLimiter.clearStaleRequests) {
        const clearedCount = window.CommonUtils.gameStateLimiter.clearStaleRequests();
        if (clearedCount > 0) {
            console.log(`üßπ BankPreview: –û—á–∏—â–µ–Ω–æ ${clearedCount} –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤`);
        }
    }
}, 60000);
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:**
1. **Race Conditions**: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `_isUpdating` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è concurrent –≤—ã–∑–æ–≤–æ–≤
2. **–°–ø–∞–º –∑–∞–ø—Ä–æ—Å—ã**: –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ rate limiting —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
3. **–ó–∞–≤–∏—Å—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—Ç–∞—Ä—à–µ 30 —Å–µ–∫—É–Ω–¥
4. **–ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**: –£–≤–µ–ª–∏—á–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å 30 –¥–æ 45 —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### ‚ö° **–£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
1. **Debouncing**: –°–æ–±—ã—Ç–∏—è –±–∞–Ω–∫–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç debounced –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (2 —Å–µ–∫)
2. **Rate Limiting**: –£–≤–µ–ª–∏—á–µ–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è game-state –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ 8 —Å–µ–∫—É–Ω–¥
3. **Memory Leaks**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –∏ —Ñ–ª–∞–≥–æ–≤ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

### üìä **–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Å–ø–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Å–æ–ª–∏
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä API
- –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ rate limiting —Å–∏—Å—Ç–µ–º—ã
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- `assets/js/modules/game/BankPreview.js`
- `assets/js/utils/CommonUtils.js`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç concurrent –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –£–ª—É—á—à–µ–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π rate limiting
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- –£–≤–µ–ª–∏—á–µ–Ω—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

–ü—Ä–æ–±–ª–µ–º–∞ —Å–ø–∞–º-–∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ—à–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, —Ç–∞–∫ –∏ —Å–∏—Å—Ç–µ–º—ã rate limiting.
