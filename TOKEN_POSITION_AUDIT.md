# Аудит позиционирования фишек

## Цель
Обеспечить, чтобы единственным источником истины для позиций фишек был сервер.

## Найденные проблемы

### ❌ КРИТИЧНО: GameState.movePlayer() изменяет позицию на клиенте
**Файл:** `assets/js/modules/GameState.js:770`
- Метод `movePlayer()` напрямую изменяет `player.position` и `player.isInner` на клиенте
- Это создает конфликт с данными сервера
- **Решение:** Удалить или отключить этот метод, позиция должна приходить только с сервера

### ⚠️ GameStateManager._normalisePlayer() устанавливает дефолт 0
**Файл:** `assets/js/modules/GameStateManager.js:855`
- Устанавливает `position: 0` по умолчанию, если позиция не указана
- Это может перезаписывать данные с сервера, если сервер передал `position: undefined`
- **Решение:** Использовать позицию из данных сервера без изменений, дефолт только если сервер явно не передал позицию

### ⚠️ PlayerTokens.normalizePlayers() устанавливает дефолт 0
**Файл:** `assets/js/modules/game/PlayerTokens.js:1832`
- Устанавливает `position: 0` по умолчанию
- Это может перезаписывать данные с сервера
- **Решение:** Использовать позицию из данных сервера без изменений

### ⚠️ PlayerTokens.forceUpdateFromGameState() использует fallback 0
**Файл:** `assets/js/modules/game/PlayerTokens.js:1645, 1667`
- Использует `Number(player.position) || 0`, что может перезаписывать позицию 0
- **Решение:** Использовать `Number.isFinite(Number(player.position)) ? Number(player.position) : null` и обрабатывать null отдельно

### ✅ ПРАВИЛЬНО: routes/rooms.js normalizePlayer()
**Файл:** `routes/rooms.js:61`
- Использует `toNumber(source.position, 0)` - это сервер, он может устанавливать дефолт
- Это единственное место, где должна устанавливаться позиция по умолчанию

### ⚠️ MovementService может конфликтовать
**Файл:** `assets/js/modules/game/MovementService.js`
- Отдельная система управления позициями
- Может конфликтовать с данными сервера
- **Решение:** Убедиться, что MovementService не используется для установки позиций, только для анимации

## План исправлений

1. ✅ **Отключен GameState.movePlayer()** - метод помечен как DEPRECATED и не изменяет позиции
2. ✅ **Исправлены нормализации** - теперь не перезаписывают позиции, если они есть с сервера
3. ⚠️ **MovementService** - используется только для анимации, не устанавливает позиции в GameStateManager
4. ✅ **Валидация** - все нормализации проверяют тип данных перед использованием

## Выполненные исправления

### ✅ GameState.movePlayer() отключен
- Метод помечен как DEPRECATED
- Не изменяет позиции на клиенте
- Выводит предупреждение при вызове

### ✅ GameStateManager._normalisePlayer() исправлен
- Использует позицию из данных сервера без изменений
- Дефолт 0 устанавливается только если сервер явно не передал позицию (null/undefined)
- Если сервер передал позицию (даже 0), использует её как есть

### ✅ PlayerTokens.normalizePlayers() исправлен
- Использует позицию из данных сервера без изменений
- Не перезаписывает позиции, если они есть с сервера

### ✅ PlayerTokens.forceUpdateFromGameState() исправлен
- Использует позиции из состояния игры с сервера без изменений
- Правильно обрабатывает null/undefined значения

## Итог

Теперь **единственным источником истины для позиций фишек является сервер**:
- Сервер устанавливает позиции через `routes/rooms.js normalizePlayer()`
- Клиент использует позиции с сервера без изменений
- Нет дублирования логики позиционирования
- Все нормализации проверяют тип данных перед использованием

