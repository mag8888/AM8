# Аудит позиционирования фишек

## Цель
Обеспечить, чтобы единственным источником истины для позиций фишек был сервер.

## Найденные проблемы

### ❌ КРИТИЧНО: GameState.movePlayer() изменяет позицию на клиенте
**Файл:** `assets/js/modules/GameState.js:770`
- Метод `movePlayer()` напрямую изменяет `player.position` и `player.isInner` на клиенте
- Это создает конфликт с данными сервера
- **Решение:** Удалить или отключить этот метод, позиция должна приходить только с сервера

### ⚠️ GameStateManager._normalisePlayer() устанавливает дефолт 0
**Файл:** `assets/js/modules/GameStateManager.js:855`
- Устанавливает `position: 0` по умолчанию, если позиция не указана
- Это может перезаписывать данные с сервера, если сервер передал `position: undefined`
- **Решение:** Использовать позицию из данных сервера без изменений, дефолт только если сервер явно не передал позицию

### ⚠️ PlayerTokens.normalizePlayers() устанавливает дефолт 0
**Файл:** `assets/js/modules/game/PlayerTokens.js:1832`
- Устанавливает `position: 0` по умолчанию
- Это может перезаписывать данные с сервера
- **Решение:** Использовать позицию из данных сервера без изменений

### ⚠️ PlayerTokens.forceUpdateFromGameState() использует fallback 0
**Файл:** `assets/js/modules/game/PlayerTokens.js:1645, 1667`
- Использует `Number(player.position) || 0`, что может перезаписывать позицию 0
- **Решение:** Использовать `Number.isFinite(Number(player.position)) ? Number(player.position) : null` и обрабатывать null отдельно

### ✅ ПРАВИЛЬНО: routes/rooms.js normalizePlayer()
**Файл:** `routes/rooms.js:61`
- Использует `toNumber(source.position, 0)` - это сервер, он может устанавливать дефолт
- Это единственное место, где должна устанавливаться позиция по умолчанию

### ⚠️ MovementService может конфликтовать
**Файл:** `assets/js/modules/game/MovementService.js`
- Отдельная система управления позициями
- Может конфликтовать с данными сервера
- **Решение:** Убедиться, что MovementService не используется для установки позиций, только для анимации

## План исправлений

1. **Удалить GameState.movePlayer()** или сделать его read-only
2. **Исправить нормализации** - не перезаписывать позиции, если они есть с сервера
3. **Убедиться, что MovementService** не устанавливает позиции, только анимирует
4. **Добавить валидацию** - проверять, что позиции приходят с сервера

