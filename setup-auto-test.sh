#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
# –ó–∞–ø—É—Å–∫: ./setup-auto-test.sh

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CRON_JOB="0,10,20,30,40,50 * * * * cd $SCRIPT_DIR && node test-site.js >> site-test.log 2>&1"

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞ –≤ crontab
if crontab -l 2>/dev/null | grep -q "test-site.js"; then
    echo "‚ö†Ô∏è  –ó–∞–¥–∞—á–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ crontab"
    echo "–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏:"
    crontab -l | grep "test-site.js"
    echo ""
    read -p "–ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 0
    fi
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É
    crontab -l 2>/dev/null | grep -v "test-site.js" | crontab -
fi

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

echo "‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ crontab"
echo ""
echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç (0, 10, 20, 30, 40, 50 –º–∏–Ω—É—Ç –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞)"
echo "–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤: $SCRIPT_DIR/site-test.log"
echo ""
echo "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f $SCRIPT_DIR/site-test.log"
echo "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á: crontab -l"
echo "–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: crontab -e (—É–¥–∞–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å test-site.js)"

