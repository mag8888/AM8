#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ–º–Ω–∞—Ç
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç cron –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ–º–Ω–∞—Ç..."

# –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_PATH=$(pwd)
SCRIPT_PATH="$PROJECT_PATH/scripts/cleanupOldRooms.js"

echo "üìÅ –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É: $PROJECT_PATH"
echo "üìÑ –ü—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É: $SCRIPT_PATH"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–∫—Ä–∏–ø—Ç
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç cleanupOldRooms.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è cron
CRON_TEMP="/tmp/am8_cleanup_cron"

# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É cron
cat > "$CRON_TEMP" << EOF
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–Ω–∞—Ç AM8 (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)
*/30 * * * * cd $PROJECT_PATH && node scripts/cleanupOldRooms.js >> logs/cleanup.log 2>&1

# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤ 2:00 (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)
0 2 * * * cd $PROJECT_PATH && node scripts/cleanupOldRooms.js --verbose >> logs/cleanup.log 2>&1
EOF

echo "üìã –ó–∞–¥–∞—á–∞ cron:"
cat "$CRON_TEMP"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p logs

echo ""
echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cron –∑–∞–¥–∞—á–∏..."

# –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ crontab
crontab "$CRON_TEMP"

if [ $? -eq 0 ]; then
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    echo ""
    echo "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
    echo "  - –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç: –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–Ω–∞—Ç"
    echo "  - –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 2:00: –ø–æ–¥—Ä–æ–±–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å –ª–æ–≥–∞–º–∏"
    echo ""
    echo "üìÑ –õ–æ–≥–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤: logs/cleanup.log"
    echo ""
    echo "üîç –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ cron –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: crontab -l"
    echo "üóëÔ∏è –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è cron –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: crontab -r"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cron –∑–∞–¥–∞—á–∏!"
    exit 1
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm "$CRON_TEMP"

echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
