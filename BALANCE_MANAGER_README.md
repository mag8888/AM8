# üí∞ BalanceManager - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –û–±–∑–æ—Ä

`BalanceManager` - —ç—Ç–æ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ Aura Money. –ú–æ–¥—É–ª—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```javascript
// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
const balanceManager = new BalanceManager({
    gameState: gameStateInstance  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
window.balanceManager = balanceManager;
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```javascript
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
balanceManager.updateBalance('player123', 5000, 'bank-api');

// –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
const balance = balanceManager.getBalance('player123');

// –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ GameState
balanceManager.refreshFromGameState(playersArray);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
const canAfford = balanceManager.hasEnoughMoney('player123', 1000);
```

## üîß API Reference

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### `updateBalance(userId, newBalance, source)`
–û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` (string) - ID –∏–≥—Ä–æ–∫–∞
- `newBalance` (number) - –ù–æ–≤–∞—è —Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–∞
- `source` (string) - –ò—Å—Ç–æ—á–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 'game-state', 'bank-api', 'manual'

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ (< 3 —Å–µ–∫)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI —ç–ª–µ–º–µ–Ω—Ç—ã

#### `getBalance(userId)`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** number (–±–∞–ª–∞–Ω—Å –∏–ª–∏ 0 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω)

#### `refreshFromGameState(players)`
–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∏–≥—Ä–æ–∫–æ–≤.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `players` (Array) - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏ `id` –∏ `cash`

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- Debounce 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

#### `getAllBalances()`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã –≤ –≤–∏–¥–µ –æ–±—ä–µ–∫—Ç–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `{ [userId]: { amount, source, timestamp } }`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### `clearBalances()`
–û—á–∏—â–∞–µ—Ç –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

#### `isDataFresh(userId)`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** boolean (true –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–µ–µ 3 —Å–µ–∫—É–Ω–¥)

#### `getStats()`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º –±–∞–ª–∞–Ω—Å–∞–º.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```javascript
{
    totalPlayers: number,
    totalBalance: number,
    averageBalance: number,
    minBalance: number,
    maxBalance: number
}
```

#### `hasEnoughMoney(userId, requiredAmount)`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤ —É –∏–≥—Ä–æ–∫–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** boolean

#### `getFormattedBalance(userId)`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** string (–Ω–∞–ø—Ä–∏–º–µ—Ä, "$5,000")

## üé® UI –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

BalanceManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã:

1. **–ü–∞–Ω–µ–ª—å –∏–≥—Ä–æ–∫–∞** - `.player-balance`
2. **–ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å** - `.right-panel .balance`
3. **–ö–∞—Ä—Ç–æ—á–∫–∏ –∏–≥—Ä–æ–∫–æ–≤** - `[data-player-id] .player-balance`
4. **–ò–≥—Ä–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - `.game-operations-card .player-balance`

### –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è CSS –∫–ª–∞—Å—Å `balance-updated` —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π:

```css
.balance-updated {
    animation: balance-updated 1s ease-in-out;
}
```

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### Debounce
- `refreshFromGameState`: –Ω–µ —á–∞—â–µ 5 —Å–µ–∫—É–Ω–¥
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–µ–µ 3 —Å–µ–∫—É–Ω–¥
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–¥–µ—Ä–≥–∞–Ω–∏–µ" UI

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ userId –∏ newBalance
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ —á–∏—Å–ª–æ–≤–æ–º—É —Ç–∏–ø—É

## üîÑ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:
1. **manual** - –†—É—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
2. **bank-api** - –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
3. **game-state** - –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ —á–µ—Ä–µ–∑ polling

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
```javascript
// –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏:
- –ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –ò–õ–ò
- –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ (> 3 —Å–µ–∫)
// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏:
- –ë–∞–ª–∞–Ω—Å —Ç–æ—Ç –∂–µ –ò –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `test-balance-manager.html` —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Ç–µ—Å—Ç–æ–≤:

- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π:
```javascript
üí∞ BalanceManager: player123 –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ 5000 (bank-api)
üîÑ BalanceManager: –û–±–Ω–æ–≤–ª–µ–Ω—ã –±–∞–ª–∞–Ω—Å—ã –¥–ª—è 4 –∏–≥—Ä–æ–∫–æ–≤
‚ö†Ô∏è BalanceManager: –ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è player123 (unchanged, fresh)
‚úÖ BalanceManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- `updateBalance`: < 5ms
- `getBalance`: < 1ms
- `refreshFromGameState`: < 20ms (–¥–ª—è 8 –∏–≥—Ä–æ–∫–æ–≤)
- `getAllBalances`: < 2ms

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ destroy()

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:
- `TurnController` - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
- `app.js` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- `PlayersPanel` - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
- `BankClientV2` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `GameState` - –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- DOM —ç–ª–µ–º–µ–Ω—Ç—ã —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```javascript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
const balanceManager = new BalanceManager({ gameState });

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
balanceManager.updateBalance(userId, newBalance, 'bank-api');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π
if (balanceManager.hasEnoughMoney(userId, itemPrice)) {
    // –ü–æ–∫—É–ø–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–≥—Ä–æ–≤—ã–º —Ü–∏–∫–ª–æ–º:
```javascript
// –í updateGameInterface
if (this.balanceManager && roomData.players) {
    this.balanceManager.refreshFromGameState(roomData.players);
}
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```javascript
const stats = balanceManager.getStats();
console.log(`–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤: $${stats.totalBalance}`);
```

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
- [ ] –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –±—É–¥—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ
- [ ] –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- [ ] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤

---

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 11 –æ–∫—Ç—è–±—Ä—è 2024  
**–ê–≤—Ç–æ—Ä:** Client-side Team
